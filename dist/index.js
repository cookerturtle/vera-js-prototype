var __create=Object.create,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__commonJS=(e,t)=>function r(){return t||(0,e[__getOwnPropNames(e)[0]])((t={exports:{}}).exports,t),t.exports},__copyProps=(e,t,r,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let n of __getOwnPropNames(t))__hasOwnProp.call(e,n)||n===r||__defProp(e,n,{get:()=>t[n],enumerable:!(o=__getOwnPropDesc(t,n))||o.enumerable});return e},__toESM=(e,t,r)=>(r=null!=e?__create(__getProtoOf(e)):{},__copyProps(!t&&e&&e.__esModule?r:__defProp(r,"default",{value:e,enumerable:!0}),e)),require_isObject=__commonJS({"node_modules/lodash/isObject.js"(e,t){t.exports=function e(t){var r=typeof t;return null!=t&&("object"==r||"function"==r)}}}),require_freeGlobal=__commonJS({"node_modules/lodash/_freeGlobal.js"(e,t){var r="object"==typeof global&&global&&global.Object===Object&&global;t.exports=r}}),require_root=__commonJS({"node_modules/lodash/_root.js"(e,t){var r=require_freeGlobal(),o="object"==typeof self&&self&&self.Object===Object&&self,n=r||o||Function("return this")();t.exports=n}}),require_now=__commonJS({"node_modules/lodash/now.js"(e,t){var r=require_root(),o=function(){return r.Date.now()};t.exports=o}}),require_trimmedEndIndex=__commonJS({"node_modules/lodash/_trimmedEndIndex.js"(e,t){var r=/\s/;t.exports=function e(t){for(var o=t.length;o--&&r.test(t.charAt(o)););return o}}}),require_baseTrim=__commonJS({"node_modules/lodash/_baseTrim.js"(e,t){var r=require_trimmedEndIndex(),o=/^\s+/;t.exports=function e(t){return t?t.slice(0,r(t)+1).replace(o,""):t}}}),require_Symbol=__commonJS({"node_modules/lodash/_Symbol.js"(e,t){var r=require_root().Symbol;t.exports=r}}),require_getRawTag=__commonJS({"node_modules/lodash/_getRawTag.js"(e,t){var r=require_Symbol(),o=Object.prototype,n=o.hasOwnProperty,l=o.toString,i=r?r.toStringTag:void 0;t.exports=function e(t){var r=n.call(t,i),o=t[i];try{t[i]=void 0;var s=!0}catch(a){}var c=l.call(t);return s&&(r?t[i]=o:delete t[i]),c}}}),require_objectToString=__commonJS({"node_modules/lodash/_objectToString.js"(e,t){var r=Object.prototype.toString;t.exports=function e(t){return r.call(t)}}}),require_baseGetTag=__commonJS({"node_modules/lodash/_baseGetTag.js"(e,t){var r=require_Symbol(),o=require_getRawTag(),n=require_objectToString(),l=r?r.toStringTag:void 0;t.exports=function e(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":l&&l in Object(t)?o(t):n(t)}}}),require_isObjectLike=__commonJS({"node_modules/lodash/isObjectLike.js"(e,t){t.exports=function e(t){return null!=t&&"object"==typeof t}}}),require_isSymbol=__commonJS({"node_modules/lodash/isSymbol.js"(e,t){var r=require_baseGetTag(),o=require_isObjectLike();t.exports=function e(t){return"symbol"==typeof t||o(t)&&"[object Symbol]"==r(t)}}}),require_toNumber=__commonJS({"node_modules/lodash/toNumber.js"(e,t){var r=require_baseTrim(),o=require_isObject(),n=require_isSymbol(),l=0/0,i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,a=/^0o[0-7]+$/i,c=parseInt;t.exports=function e(t){if("number"==typeof t)return t;if(n(t))return l;if(o(t)){var h="function"==typeof t.valueOf?t.valueOf():t;t=o(h)?h+"":h}if("string"!=typeof t)return 0===t?t:+t;t=r(t);var u=s.test(t);return u||a.test(t)?c(t.slice(2),u?2:8):i.test(t)?l:+t}}}),require_debounce=__commonJS({"node_modules/lodash/debounce.js"(e,t){var r=require_isObject(),o=require_now(),n=require_toNumber(),l=Math.max,i=Math.min;t.exports=function e(t,s,a){var c,h,u,d,v,p,g=0,f=!1,m=!1,y=!0;if("function"!=typeof t)throw TypeError("Expected a function");function b(e){var r=c,o=h;return c=h=void 0,g=e,d=t.apply(o,r)}function $(e){var t=e-p,r=e-g;return void 0===p||t>=s||t<0||m&&r>=u}function S(){var e,t,r,n,l=o();if($(l))return x(l);v=setTimeout(S,(t=(e=l)-p,r=e-g,n=s-t,m?i(n,u-r):n))}function x(e){return(v=void 0,y&&c)?b(e):(c=h=void 0,d)}function E(){var e,t=o(),r=$(t);if(c=arguments,h=this,p=t,r){if(void 0===v)return g=e=p,v=setTimeout(S,s),f?b(e):d;if(m)return clearTimeout(v),v=setTimeout(S,s),b(p)}return void 0===v&&(v=setTimeout(S,s)),d}return s=n(s)||0,r(a)&&(f=!!a.leading,u=(m="maxWait"in a)?l(n(a.maxWait)||0,s):u,y="trailing"in a?!!a.trailing:y),E.cancel=function e(){void 0!==v&&clearTimeout(v),g=0,c=p=h=v=void 0},E.flush=function e(){return void 0===v?d:x(o())},E}}}),require_throttle=__commonJS({"node_modules/lodash/throttle.js"(e,t){var r=require_debounce(),o=require_isObject();t.exports=function e(t,n,l){var i=!0,s=!0;if("function"!=typeof t)throw TypeError("Expected a function");return o(l)&&(i="leading"in l?!!l.leading:i,s="trailing"in l?!!l.trailing:s),r(t,n,{leading:i,maxWait:n,trailing:s})}}});function detectIFrame(){return window.top!==window.self}var EventRelay=class{constructor(e){this.postMesssage=e}relayEvent(e){this.postMesssage&&window.parent.postMessage({timestamp:e.time,type:e.type,data:e.data},"*")}},VeraEvent=class{time;data;type;constructor(e,t){this.time=Date.now(),this.data=e,this.type=t??"Event"}},Tracker=class{constructor(e){this.tracker=e,this.setHandler()}},NUM_SCROLL_EVENTS=10,import_throttle=__toESM(require_throttle()),ScrollEvent=class extends VeraEvent{constructor(e,t){super({percentage:e,direction:t},"ScrollEvent")}},ScrollTracker=class e extends Tracker{static THRESHOLDS=[...Array(NUM_SCROLL_EVENTS).keys()].map(e=>(e+1)*(100/NUM_SCROLL_EVENTS));maxScroll=[0,0];setHandler(){let t=()=>{let t=[Math.round((window.scrollY+innerHeight)/document.body.scrollHeight*100),Math.round((window.scrollX+innerWidth)/document.body.scrollWidth*100)];t.forEach((t,r)=>{let o=e.THRESHOLDS.find(e=>e>this.maxScroll[r]&&t>e);if(o){let n=new ScrollEvent(o,r?"hor":"ver");this.tracker.recordEvent(n)}})};window.addEventListener("scroll",(0,import_throttle.default)(t,250))}},ClickEvent=class extends VeraEvent{constructor(e,t,r,o,n){super({type:e,id:t,classes:r,text:o,href:n},"ClickEvent")}},ClickTracker=class extends Tracker{setHandler(){document.addEventListener("click",e=>{let t=e.target,r=t.tagName.toLowerCase(),o=null;t instanceof HTMLAnchorElement&&(o=t.href);let n=new ClickEvent(r,t.id,Array.from(t.classList),t.textContent,o);this.tracker.recordEvent(n)})}};async function rebuildSelector({eventId:e,elementPath:t,elementIndex:r},o,n){let l=locate(t);if(!l)return post({type:"vt-rebuild-result",eventId:e,error:"not-found"},n);let i=buildSelector(l),s=i.join(" > "),a=document.querySelectorAll(s).length;post({type:"vt-rebuild-result",eventId:e,selector:i,matchCount:a},n),o(i.slice(0,r+1).join(" > "))}function buildSelector(e){let t=[],r=e;for(;r&&1===r.nodeType&&"html"!==r.tagName.toLowerCase();){let o=r.tagName.toLowerCase(),n="";r.id&&(n=`#${CSS.escape(r.id)}`);let l="";if(r.classList.length>0&&(l="."+Array.from(r.classList).map(e=>CSS.escape(e)).join(".")),t.unshift(`${o}${n}${l}`),"body"===o)break;r=r.parentElement}return t}function pathToRoot(e){let t=[],r=e;for(;r&&r.parentElement;)t.unshift(Array.from(r.parentElement.children).indexOf(r)),r=r.parentElement;return t}function locate(e){let t=document.documentElement;for(let r of e){if(!t||!t.children[r])return null;t=t.children[r]}return t}function post(e,t){try{let{type:r,...o}=e,n=new VeraEvent(o,r);t.tracker.recordEvent(n)}catch(l){console.error("postMessage error",l)}}function collectMeta(e,t){let r=(e.textContent||"").trim();return{href:e.getAttribute("href")||null,src:e.getAttribute("src")||null,value:t.stripValues?null:e.value||e.getAttribute("value"),dataset:e instanceof HTMLElement?{...e.dataset}:{},text:t.hashText?"":r.slice(0,200)}}var SelectorHighlighter=class e extends Tracker{matchOverlays=[];highlightingMatches=!1;highlightingHovers=!0;static hoverOverlay=document.createElement("div");currentSelector="";setHandler(){e.hoverOverlay.style.position="absolute",e.hoverOverlay.style.pointerEvents="none",e.hoverOverlay.style.border="2px solid rgba(0, 128, 255, 0.7)",e.hoverOverlay.style.borderRadius="4px",e.hoverOverlay.style.boxShadow="0 0 10px rgba(0, 128, 255, 0.3)",e.hoverOverlay.style.zIndex="999999",e.hoverOverlay.style.transition="all 100ms ease",document.body.appendChild(e.hoverOverlay);let t=null;document.addEventListener("mousemove",r=>{if(this.highlightingMatches||!this.highlightingHovers){e.hoverOverlay.style.display="none";return}let o=r.target;o===e.hoverOverlay||e.hoverOverlay.contains(o)||o===t||(t=o,function t(r){let o=r.getBoundingClientRect();e.hoverOverlay.style.top=`${window.scrollY+o.top}px`,e.hoverOverlay.style.left=`${window.scrollX+o.left}px`,e.hoverOverlay.style.width=`${o.width}px`,e.hoverOverlay.style.height=`${o.height}px`,e.hoverOverlay.style.display="block"}(o))}),document.addEventListener("mouseout",r=>{r.relatedTarget&&this.highlightingMatches&&!this.highlightingHovers||(e.hoverOverlay.style.display="none",t=null)})}createMatchOverlay(){let e=document.createElement("div");return e.style.position="absolute",e.style.pointerEvents="none",e.style.border="2px solid rgba(255, 165, 0, 0.8)",e.style.borderRadius="4px",e.style.boxShadow="0 0 8px rgba(255, 165, 0, 0.4)",e.style.zIndex="999998",e.style.transition="all 100ms ease",e}clearMatchOverlays=()=>{this.matchOverlays.forEach(e=>e.remove()),this.matchOverlays.length=0,this.currentSelector=""};highlightMatches=t=>{e.hoverOverlay.style.display="none";let r=document.querySelectorAll(t);if(""===this.currentSelector){if(0===r.length)return;r[0].scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}if(this.highlightingMatches&&this.currentSelector!==t){this.clearMatchOverlays(),this.currentSelector=t;try{r.forEach(e=>{let t=e.getBoundingClientRect(),r=this.createMatchOverlay();r.style.top=`${window.scrollY+t.top}px`,r.style.left=`${window.scrollX+t.left}px`,r.style.width=`${t.width}px`,r.style.height=`${t.height}px`,document.body.appendChild(r),this.matchOverlays.push(r)})}catch(o){console.error("Invalid Selector",o)}}}},defaultCfg={events:["click"],pii:{hashText:!1,stripValues:!0},targetOrigin:"*"},handle=(e,t)=>{let r=e.target;if(!r||!(r instanceof Element))return;let o=buildSelector(r),n=r.getBoundingClientRect(),l={type:"vt-event",eventType:e.type,selector:o,elementPath:pathToRoot(r),meta:collectMeta(r,defaultCfg.pii),bbox:{x:n.x,y:n.y,w:n.width,h:n.height},timestamp:Date.now(),frameURL:location.href};post(l,t)},VisualEventTracker=class extends Tracker{listenersAttached=!1;eventListeners=[];setHandler(){post({type:"vt-init",frameURL:location.href},this);let e=new SelectorHighlighter(this.tracker),t=()=>{this.listenersAttached||(defaultCfg.events.forEach(e=>{this.eventListeners.push(t=>{"click"===e&&t.stopPropagation(),handle(t,this)}),window.addEventListener(e,this.eventListeners.at(-1),!0)}),this.listenersAttached=!0)},r=()=>{this.listenersAttached&&(defaultCfg.events.forEach((e,t)=>{window.removeEventListener(e,this.eventListeners[t],!0)}),this.eventListeners=[],this.listenersAttached=!1)};window.addEventListener("message",o=>{let n=o.data;n?.type==="vt-config"&&(defaultCfg={...defaultCfg,...n?.cfg},t()),n?.type==="vt-end"&&r(),n?.type==="vt-rebuild"&&rebuildSelector(n,e.highlightingMatches?e.highlightMatches:()=>null,this),n?.type==="vt-beginEdit"&&(e.highlightingMatches=!0),n?.type==="vt-endEdit"&&(e.highlightingMatches=!1,e.clearMatchOverlays()),n?.type==="vte-endHover"&&(e.highlightingHovers=!1),n?.type==="vte-beginHover"&&(e.highlightingHovers=!0)})}},RightClickTracker=class extends Tracker{setHandler(){document.addEventListener("contextmenu",e=>{e.preventDefault();let t=e.target,r=buildSelector(t),o=new VeraEvent({selector:r,x:e.clientX,y:e.clientY},"vte-rclick");this.tracker.recordEvent(o)},!0)}},TrackerManager=class{constructor(e){this.postMessage=e,this.relay=new EventRelay(e),new ClickTracker(this),new ScrollTracker(this),new RightClickTracker(this);let t;e&&(t=new VisualEventTracker(this))}relay;recordEvent(e){this.relay.relayEvent(e)}},tracker=new TrackerManager(detectIFrame());
